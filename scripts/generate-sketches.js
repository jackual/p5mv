import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import chroma from 'chroma-js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

async function generateSketchesIndex() {
    const sketchesDir = path.join(__dirname, '..', 'public', 'sketches');
    const outputFile = path.join(__dirname, '..', 'data', 'sketches.js');
    const scssOutputFile = path.join(__dirname, '..', 'app', 'styles', '_scene-colors.scss');

    try {
        // Get all directories in sketches folder
        const entries = fs.readdirSync(sketchesDir, { withFileTypes: true });
        const sketchDirs = entries
            .filter(entry => entry.isDirectory())
            .map(entry => entry.name)
            .sort();

        console.log(`Found ${sketchDirs.length} sketch directories:`, sketchDirs);

        // Generate a color scale for all sketches
        const colorScale = chroma.scale(['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#fd79a8', '#fdcb6e', '#6c5ce7', '#a29bfe', '#fd79a8', '#00cec9']).mode('lch').colors(sketchDirs.length);

        // Import all info.js files
        const imports = [];
        const sketches = [];

        for (let i = 0; i < sketchDirs.length; i++) {
            const dirName = sketchDirs[i];
            const infoPath = path.join(sketchesDir, dirName, 'info.js');

            if (fs.existsSync(infoPath)) {
                // Dynamically import to check for skip flag
                const infoModule = await import(`../public/sketches/${dirName}/info.js`);
                const info = infoModule.default;
                
                if (info.skip) {
                    console.log(`Skipping ${dirName} (skip: true)`);
                    continue;
                }
                
                const importName = `${dirName}Info`;
                const color = colorScale[i];
                imports.push(`import ${importName} from '../public/sketches/${dirName}/info.js';`);
                sketches.push(`  { ...${importName}, id: '${dirName}', color: '${color}' }`);
            } else {
                console.warn(`Warning: No info.js found in ${dirName} directory`);
            }
        }

        // Generate the file content
        const fileContent = `// This file is auto-generated by scripts/generate-sketches.js
// Do not edit manually - run 'npm run generate-sketches' to update

${imports.join('\n')}

export default [
${sketches.join(',\n')}
];
`;

        // Ensure data directory exists
        const dataDir = path.dirname(outputFile);
        if (!fs.existsSync(dataDir)) {
            fs.mkdirSync(dataDir, { recursive: true });
        }

        // Write the JS file
        fs.writeFileSync(outputFile, fileContent);
        console.log(`Generated sketches index at: ${outputFile}`);
        console.log(`Included ${sketches.length} sketches`);

        // Generate SCSS file with scene colors
        const scssContent = generateSceneColorsScss(sketchDirs, colorScale);

        // Ensure styles directory exists
        const scssDir = path.dirname(scssOutputFile);
        if (!fs.existsSync(scssDir)) {
            fs.mkdirSync(scssDir, { recursive: true });
        }

        // Write the SCSS file
        fs.writeFileSync(scssOutputFile, scssContent);
        console.log(`Generated scene colors SCSS at: ${scssOutputFile}`);

    } catch (error) {
        console.error('Error generating sketches index:', error);
        process.exit(1);
    }
}

function generateSceneColorsScss(sketchDirs, colorScale) {
    let scss = `// This file is auto-generated by scripts/generate-sketches.js
// Do not edit manually - run 'npm run generate-sketches' to update

// Scene-specific region colors
`;

    // Generate colors for each scene
    sketchDirs.forEach((sceneId, index) => {
        const baseColor = colorScale[index];
        const baseChroma = chroma(baseColor);

        // Generate color variations using chroma.js
        const lightBg = baseChroma.brighten(1.5).hex();
        const mediumBg = baseChroma.brighten(0.5).hex();
        const hoverBg1 = baseChroma.brighten(1.2).hex();
        const hoverBg2 = baseChroma.brighten(0.3).hex();
        const selectedColor = baseChroma.darken(0.2).hex();
        const resizingColor = baseChroma.alpha(0.7).css();
        const borderColor = baseChroma.darken(0.1).hex();

        // Calculate contrast for text color (unselected state)
        const bgLuminance = chroma.mix(lightBg, mediumBg, 0.5).luminance();
        const textColor = bgLuminance > 0.5 ? '#000000' : '#ffffff';

        // Calculate contrast for resizing state (semi-transparent background)
        const resizingBgLuminance = baseChroma.luminance();
        const resizingTextColor = resizingBgLuminance > 0.5 ? '#000000' : '#ffffff';

        // Selected state always uses white text for consistency
        const selectedTextColor = '#ffffff';

        scss += `
.region.scene-${sceneId} {
    background: linear-gradient(135deg, ${lightBg} 0%, ${mediumBg} 100%);
    border-color: ${borderColor};
    color: ${textColor};
    
    &:hover {
        background: linear-gradient(135deg, ${hoverBg1} 0%, ${hoverBg2} 100%);
        border-color: ${baseChroma.darken(0.3).hex()};
        color: ${textColor};
    }
    
    &.selected {
        background: ${selectedColor};
        border-color: ${baseChroma.darken(0.4).hex()};
        color: ${selectedTextColor};
    }
    
    &.resizing {
        background: ${resizingColor} !important;
        border-color: ${baseColor} !important;
        color: white;
    }
}
`;
    });

    // Add style for regions with no scene (using red theme)
    scss += `
.region.scene-none {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border-color: #f87171;
    color: #dc2626;
    
    &:hover {
        background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
        border-color: #ef4444;
        color: #dc2626;
    }
    
    &.selected {
        background: #dc2626;
        border-color: #b91c1c;
        color: #ffffff;
    }
    
    &.resizing {
        background: rgba(248, 113, 113, 0.7) !important;
        border-color: #f87171 !important;
        color: white;
    }
}
`;

    return scss;
}

generateSketchesIndex();