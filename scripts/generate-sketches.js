import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import chroma from 'chroma-js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

async function generateSketchesIndex() {
    const sketchesDir = path.join(__dirname, '..', 'public', 'sketches');
    const outputFile = path.join(__dirname, '..', 'data', 'sketches.js');

    try {
        // Get all directories in sketches folder
        const entries = fs.readdirSync(sketchesDir, { withFileTypes: true });
        const sketchDirs = entries
            .filter(entry => entry.isDirectory())
            .map(entry => entry.name)
            .sort();

        console.log(`Found ${sketchDirs.length} sketch directories:`, sketchDirs);

        // Generate a color scale for all sketches
        const colorScale = chroma.scale(['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#fd79a8', '#fdcb6e', '#6c5ce7', '#a29bfe', '#fd79a8', '#00cec9']).mode('lch').colors(sketchDirs.length);

        // Import all info.js files
        const imports = [];
        const sketches = [];

        for (let i = 0; i < sketchDirs.length; i++) {
            const dirName = sketchDirs[i];
            const infoPath = path.join(sketchesDir, dirName, 'info.js');

            if (fs.existsSync(infoPath)) {
                const importName = `${dirName}Info`;
                const color = colorScale[i];
                imports.push(`import ${importName} from '../public/sketches/${dirName}/info.js';`);
                sketches.push(`  { ...${importName}, id: '${dirName}', color: '${color}' }`);
            } else {
                console.warn(`Warning: No info.js found in ${dirName} directory`);
            }
        }

        // Generate the file content
        const fileContent = `// This file is auto-generated by scripts/generate-sketches.js
// Do not edit manually - run 'npm run generate-sketches' to update

${imports.join('\n')}

export default [
${sketches.join(',\n')}
];
`;

        // Ensure data directory exists
        const dataDir = path.dirname(outputFile);
        if (!fs.existsSync(dataDir)) {
            fs.mkdirSync(dataDir, { recursive: true });
        }

        // Write the file
        fs.writeFileSync(outputFile, fileContent);
        console.log(`Generated sketches index at: ${outputFile}`);
        console.log(`Included ${sketches.length} sketches`);

    } catch (error) {
        console.error('Error generating sketches index:', error);
        process.exit(1);
    }
}

generateSketchesIndex();