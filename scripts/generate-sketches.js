import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

async function generateSketchesIndex() {
    const sketchesDir = path.join(__dirname, '..', 'sketches');
    const outputFile = path.join(__dirname, '..', 'data', 'sketches.js');

    try {
        // Get all directories in sketches folder
        const entries = fs.readdirSync(sketchesDir, { withFileTypes: true });
        const sketchDirs = entries
            .filter(entry => entry.isDirectory())
            .map(entry => entry.name)
            .sort();

        console.log(`Found ${sketchDirs.length} sketch directories:`, sketchDirs);

        // Import all info.js files
        const imports = [];
        const sketches = [];

        for (const dirName of sketchDirs) {
            const infoPath = path.join(sketchesDir, dirName, 'info.js');

            if (fs.existsSync(infoPath)) {
                const importName = `${dirName}Info`;
                imports.push(`import ${importName} from '../sketches/${dirName}/info.js';`);
                sketches.push(`  { ...${importName}, id: '${dirName}' }`);
            } else {
                console.warn(`Warning: No info.js found in ${dirName} directory`);
            }
        }

        // Generate the file content
        const fileContent = `// This file is auto-generated by scripts/generate-sketches.js
// Do not edit manually - run 'npm run generate-sketches' to update

${imports.join('\n')}

export default [
${sketches.join(',\n')}
];
`;

        // Ensure data directory exists
        const dataDir = path.dirname(outputFile);
        if (!fs.existsSync(dataDir)) {
            fs.mkdirSync(dataDir, { recursive: true });
        }

        // Write the file
        fs.writeFileSync(outputFile, fileContent);
        console.log(`Generated sketches index at: ${outputFile}`);
        console.log(`Included ${sketches.length} sketches`);

    } catch (error) {
        console.error('Error generating sketches index:', error);
        process.exit(1);
    }
}

generateSketchesIndex();